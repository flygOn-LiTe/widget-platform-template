<svg
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  width="530"
  height="80"
  viewBox="0 0 530 80"
>
  <defs>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      svg {
        display: block;
        margin: auto;
      }

      #fill {
        transition: 3s width;
      }
      #fill-overlay {
        box-sizing: border-box;
      }

      .cls-1 {
        isolation: isolate;
      }

      .cls-2 {
        fill: #9f3b14;
      }

      .cls-3 {
        fill: #bc5810;
      }

      .cls-4,
      .cls-9 {
        fill: #f5feff;
      }

      .cls-10,
      .cls-4,
      .cls-8 {
        mix-blend-mode: screen;
      }

      .cls-4,
      .cls-5,
      .cls-8 {
        opacity: 0.4;
      }

      .cls-5 {
        fill: #301712;
      }

      .cls-5,
      .cls-7 {
        mix-blend-mode: overlay;
      }

      .cls-7 {
        fill: #460b18;
      }

      .cls-10 {
        opacity: 0.2;
        fill: url(#radial-gradient);
      }
    </style>
    <linearGradient
      id="linear-gradient"
      x1="15"
      y1="42"
      x2="515"
      y2="42"
      gradientUnits="userSpaceOnUse"
    >
      <stop offset="0" stop-color="#000" />
      <stop offset="0.03" stop-color="#6a00ff" />
      <stop offset="0.54" stop-color="#6a00ff" />
      <stop offset="0.99" stop-color="#6a00ff" />
      <stop offset="1" stop-color="#000" />
    </linearGradient>
    <radialGradient
      id="radial-gradient"
      cx="820.88"
      cy="405"
      r="187.88"
      xlink:href="#linear-gradient"
    />
  </defs>
  <g class="cls-1">
    <g id="Layer_1" data-name="Layer 1">
      <rect class="cls-2" y="3" width="530" height="76" rx="30.08" />
      <path
        class="cls-3"
        d="M1055.8,388a15.09,15.09,0,0,1,15.08,15.08v15.84A15.09,15.09,0,0,1,1055.8,434H586a15.09,15.09,0,0,1-15.08-15.08V403.08A15.09,15.09,0,0,1,586,388H1055.8m0-15H586a30.17,30.17,0,0,0-30.08,30.08v15.84A30.17,30.17,0,0,0,586,449H1055.8a30.17,30.17,0,0,0,30.08-30.08V403.08A30.17,30.17,0,0,0,1055.8,373Z"
        transform="translate(-555.88 -371)"
      />
      <path
        class="cls-4"
        d="M1055.8,371H586a30.17,30.17,0,0,0-30.08,30.08v5A30.17,30.17,0,0,1,586,376H1055.8a30.17,30.17,0,0,1,30.08,30.08v-5A30.17,30.17,0,0,0,1055.8,371Z"
        transform="translate(-555.88 -371)"
      />
      <path
        class="cls-5"
        d="M1055.8,445H586a30.17,30.17,0,0,1-30.08-30.08v6A30.17,30.17,0,0,0,586,451H1055.8a30.17,30.17,0,0,0,30.08-30.08v-6A30.17,30.17,0,0,1,1055.8,445Z"
        transform="translate(-555.88 -371)"
      />
    </g>
    <g id="bar">
      <g>
        <rect
          id="fill"
          class="cls-6"
          x="15"
          y="19"
          width="500"
          height="46"
          rx="15.08"
        />
      </g>
      <path
        class="cls-4"
        d="M1055.8,390H586a15.09,15.09,0,0,0-15.08,15.08v9A15.09,15.09,0,0,1,586,399H1055.8a15.09,15.09,0,0,1,15.08,15.08v-9A15.09,15.09,0,0,0,1055.8,390Z"
        transform="translate(-555.88 -371)"
      />
      <path
        class="cls-7"
        d="M1055.8,430H586a15.09,15.09,0,0,1-15.08-15.08v5A15.09,15.09,0,0,0,586,435H1055.8a15.09,15.09,0,0,0,15.08-15.08v-5A15.09,15.09,0,0,1,1055.8,430Z"
        transform="translate(-555.88 -371)"
      />
      <g class="cls-8">
        <rect
          id="fill-overlay"
          class="cls-9"
          x="15"
          y="19"
          width="500"
          height="46"
          rx="15.08"
        />
      </g>
      <path
        class="cls-10"
        d="M820.46,435c127.71,0,234.89-16.12,264.42-37.88a30.2,30.2,0,0,0-29-22.12H586a30.19,30.19,0,0,0-29.16,22.73C587.56,419.18,693.93,435,820.46,435Z"
        transform="translate(-555.88 -371)"
      />
    </g>
  </g>
  <text
    id="follower-count"
    x="43%"
    y="50%"
    font-family="sans-serif"
    font-weight="700"
    font-size="25"
    fill="white"
    text-anchor="middle"
    dominant-baseline="middle"
  >
    0
    <!-- Default value, will be updated by JavaScript -->
  </text>
  <text
    x="50%"
    y="50%"
    font-family="sans-serif"
    font-weight="700"
    font-size="25"
    fill="white"
    text-anchor="middle"
    dominant-baseline="middle"
  >
    /
  </text>
  <text
    id="goal-count"
    x="57%"
    y="50%"
    font-family="sans-serif"
    font-weight="700"
    font-size="25"
    fill="white"
    text-anchor="middle"
    dominant-baseline="middle"
  >
    1000
    <!-- Default goal, will be updated by JavaScript -->
  </text>
</svg>
<script>
  function getUrlParams() {
    const params = {};
    const queryString = window.location.search.substring(1);
    const keyValuePairs = queryString.split("&");

    keyValuePairs.forEach((pair) => {
      const [key, value] = pair.split("=");
      params[key] = decodeURIComponent(value);
    });

    return params;
  }

  function updateFollowerCount(count, color, goal) {
    console.log("Received count:", count);
    console.log("Received color:", color);
    console.log("Received goal:", goal);
    document.getElementById("follower-count").textContent = `${count}`;
    document.getElementById("goal-count").textContent = `${goal}`;
    const fill = document.querySelector("#fill");
    const percentage = (count / goal) * 100 + "%";
    console.log("Percentage:", percentage);
    fill.style.setProperty("width", percentage);
    if (color) {
      if (!color.startsWith("#")) {
        color = `#${color}`;
      } else {
        color = `${color}`;
      }
      fill.style.setProperty("fill", color);
    }
  }

  async function fetchFollowerCount() {
    try {
      const params = getUrlParams();
      let color = params.color;
      let goal = params.goal;
      let userId = params.userId;

      const response = await fetch(
        `{{BACKEND_URL}}/api/follower-count?userId=${userId}`
      );

      if (response.status === 401) {
        // Token has expired. The server should be refreshing it.
        // Wait for a short delay and then retry fetching the follower count.
        setTimeout(fetchFollowerCount, 2500);
        return;
      }

      const data = await response.json();
      console.log("FOLLOWER COUNT DATA", data);
      if (response.ok) {
        updateFollowerCount(data.followerCount, color, goal || 1000);
      } else {
        console.error("Failed to fetch follower count:", data.error);
      }
    } catch (error) {
      console.error("Failed to fetch follower count:", error);
    }
  }

  // Fetch the follower count when the widget is loaded
  fetchFollowerCount();

  const userId = getUrlParams().userId; // Replace with the actual user ID
  console.log("User ID from widget:", userId);
  const source = new EventSource(`{{BACKEND_URL}}/sse?userId=${userId}`);

  source.addEventListener("message", (event) => {
    const newFollowerCount = JSON.parse(event.data);
    if (newFollowerCount.eventType === "channel.follow") {
      // Update the widget UI with the new follower count
      console.log("NEW FOLLOWER COUNT", newFollowerCount.followerCount);
      document.getElementById(
        "follower-count"
      ).textContent = `${newFollowerCount.followerCount}`;
    }
  });
</script>
